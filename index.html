<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Bank</title>
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#4f46e5" />
  <link rel="manifest" href="data:application/manifest+json;base64,ew0KICAibmFtZSI6ICJNeSBCYW5rIEFwcCIsDQogICJzaG9ydF9uYW1lIjogIk15IEJhbmsiLA0KICAic3RhcnRfdXJsIjogIi4iLA0KICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwNCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2YxZjVmOSIsDQogICJ0aGVtZV9jb2xvciI6ICIjNGY0NmU1IiwNCiAgImRlc2NyaXB0aW9uIjogIllvdXIgcGVyc29uYWwgZmluYW5jaWFsIGRhc2hib2FyZC4iLA0KICAiaWNvbnMiOiBbDQogICAgew0KICAgICAgInNyYyI6ICJodHRwczovL3BsYWNlaG9sZC5jby8xOTJ4MTkyLzRmNDZlNS9mZmZmZmY/dGV4dD1CYW5rIiwNCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwNCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyINCiAgICB9LA0KICAgIHsNCiAgICAgICJzcmMiOiAiaHR0cHM6Ly9wbGFjZWhvbGQuY28vNTEyeDUxMi80ZjQ2ZTUvZmZmZmZmP3RleHQ9QmFuayIsDQogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsDQogICAgICAidHlwZSI6ICJpbWFnZS9wbmciDQogICAgfQ0KICBdDQp9">

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    .pin-input {
      width: 3rem;
      height: 3rem;
      text-align: center;
      font-size: 1.5rem;
      border-radius: 0.5rem;
      border: 1px solid #cbd5e1;
    }
  </style>
</head>

<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">

  <!-- Auth Container -->
  <div id="auth-container" class="page active w-full max-w-sm mx-auto">
    <div class="bg-white p-8 rounded-2xl shadow-xl">
      <div class="text-center mb-6">
        <h1 id="auth-title" class="text-2xl font-bold text-slate-800">Welcome Back!</h1>
        <p id="auth-subtitle" class="text-slate-500">Login to continue.</p>
      </div>
      <div class="space-y-4">
        <div id="fullname-field" class="hidden"><input type="text" id="fullname" placeholder="Full Name" class="w-full px-4 py-2 border border-slate-300 rounded-lg"></div>
        <input type="email" id="email" placeholder="Email Address" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
        <input type="password" id="password" placeholder="Password (min. 6 characters)" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
        <div id="pin-field" class="hidden"><input type="number" id="pin" placeholder="Create 4-Digit PIN" class="w-full px-4 py-2 border border-slate-300 rounded-lg" maxlength="4"></div>
        <p id="auth-error" class="text-red-500 text-sm h-4"></p>
        <button id="auth-button" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg">Login</button>
        <p class="text-center text-sm text-slate-500 pt-2"><span id="auth-toggle-text">Don't have an account?</span> <a href="#" id="auth-toggle-link" class="font-semibold text-indigo-600 hover:underline">Sign Up</a></p>
      </div>
    </div>
  </div>

  <!-- Main App Container -->
  <div id="app-container" class="page w-full max-w-md mx-auto">
    <!-- Dashboard Page -->
    <div id="dashboard-page" class="page active bg-white rounded-2xl shadow-xl p-6">
      <header class="mb-6 flex justify-between items-center">
        <div class="flex items-center space-x-4">
          <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTSv856GZFHOdXPOAhXx8WUMaYCknECTEus4iUB-whCow&s" alt="Bank Logo" class="w-14 h-14 rounded-full object-cover">
          <div>
            <h1 class="text-xl font-bold text-slate-800">Welcome, <span id="user-name">User</span>!</h1>
            <p class="text-slate-500">Your financial dashboard.</p>
          </div>
        </div>
        <button id="logout-btn" class="text-sm bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">Logout</button>
      </header>

      <section id="summary" class="mb-6">
        <div class="bg-slate-50 p-4 rounded-lg">
          <div class="flex justify-between items-center">
            <h2 class="text-sm font-medium text-slate-500 uppercase">Current Balance</h2>
            <select id="currency-selector" class="bg-white border border-slate-300 rounded-md text-sm p-1">
              <option value="$">USD ($)</option>
              <option value="₦" selected>NGN (₦)</option>
              <option value="€">EUR (€)</option>
              <option value="£">GBP (£)</option>
            </select>
          </div>
          <p id="balance" class="text-3xl font-bold text-slate-800 mt-1">₦0.00</p>
          <div class="flex mt-4 space-x-4">
            <div class="w-1/2 bg-green-100 text-green-800 p-3 rounded-lg">
              <h3>Income</h3>
              <p id="total-income" class="text-lg font-bold">₦0.00</p>
            </div>
            <div class="w-1/2 bg-red-100 text-red-800 p-3 rounded-lg">
              <h3>Expense</h3>
              <p id="total-expense" class="text-lg font-bold">₦0.00</p>
            </div>
          </div>
        </div>
      </section>
      <section class="mb-6">
        <h2 class="text-lg font-semibold text-slate-700 mb-3">Account Details</h2>
        <div class="bg-slate-50 p-4 rounded-lg text-sm space-y-2">
          <div class="flex justify-between"><span>Account Number:</span><span id="account-number" class="font-mono">...</span></div>
          <div class="flex justify-between"><span>Routing Number:</span><span id="routing-number" class="font-mono">...</span></div>
        </div>
      </section>
      <section class="mb-6">
        <h2 class="text-lg font-semibold text-slate-700 mb-3">Actions</h2>
        <div class="grid grid-cols-3 gap-4 text-center">
          <button id="transfer-btn" class="bg-indigo-100 text-indigo-800 p-3 rounded-lg font-semibold">Transfer</button>
          <button id="bills-btn" class="bg-indigo-100 text-indigo-800 p-3 rounded-lg font-semibold">Pay Bills</button>
          <button id="deposit-btn" class="bg-indigo-100 text-indigo-800 p-3 rounded-lg font-semibold">Deposit Check</button>
        </div>
      </section>
      <section class="mb-6">
        <h2 class="text-lg font-semibold text-slate-700 mb-3">Add a Transaction</h2>
        <form id="transaction-form" class="space-y-4">
          <input type="text" id="description" placeholder="e.g., Initial Deposit, Groceries" class="w-full px-3 py-2 border border-slate-300 rounded-lg" required>
          <input type="number" id="amount" placeholder="Amount" step="0.01" class="w-full px-3 py-2 border border-slate-300 rounded-lg" required>
          <select id="type" class="w-full px-3 py-2 border border-slate-300 rounded-lg bg-white">
            <option value="income">Income</option>
            <option value="expense">Expense</option>
          </select>
          <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg">Add Transaction</button>
        </form>
      </section>
      <section>
        <h2 class="text-lg font-semibold text-slate-700 mb-3">Transaction History</h2>
        <ul id="transaction-list" class="space-y-3"></ul>
        <p id="no-transactions" class="text-center text-slate-500 mt-4">Your history will appear here.</p>
      </section>
    </div>

    <!-- Transfer Page -->
    <div id="transfer-page" class="page bg-white rounded-2xl shadow-xl p-6">
      <header class="mb-6 flex items-center">
        <button id="back-to-dashboard-btn" class="mr-4 text-slate-500 hover:text-slate-800">&larr; Back</button>
        <h1 class="text-xl font-bold text-slate-800">Send Money</h1>
      </header>
      <form id="transfer-form" class="space-y-4">
        <input type="text" id="recipient-name" placeholder="Recipient Full Name" class="w-full px-3 py-2 border border-slate-300 rounded-lg" required>
        <input type="number" id="recipient-account" placeholder="Recipient Account Number" class="w-full px-3 py-2 border border-slate-300 rounded-lg" required>
        <input type="number" id="transfer-amount" placeholder="Amount" step="0.01" class="w-full px-3 py-2 border border-slate-300 rounded-lg" required>
        <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg">Send Money</button>
      </form>
    </div>
  </div>

  <!-- Modals -->
  <div id="pin-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-xs text-center">
      <h2 class="text-lg font-bold mb-4">Enter Your PIN</h2>
      <div id="pin-inputs" class="flex justify-center space-x-2 mb-4">
        <input type="password" maxlength="1" class="pin-input"><input type="password" maxlength="1" class="pin-input"><input type="password" maxlength="1" class="pin-input"><input type="password" maxlength="1" class="pin-input">
      </div>
      <p id="pin-error" class="text-red-500 text-sm h-4 mb-4"></p>
      <button id="pin-confirm-btn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg">Confirm</button>
      <button id="pin-cancel-btn" class="w-full mt-2 text-slate-500 hover:underline">Cancel</button>
    </div>
  </div>
  <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-xs text-center">
      <p id="alert-message" class="mb-4"></p>
      <button id="alert-ok-btn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg">OK</button>
    </div>
  </div>

  <script type="module">
    import {
      initializeApp
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      query,
      onSnapshot,
      doc,
      serverTimestamp,
      setDoc,
      getDoc,
      orderBy,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    // === PASTE YOUR REAL FIREBASE CONFIG HERE ===
    Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyDSrA2e5dtgeY5I1x-IunaW9-qpCncegV0",
  authDomain: "bank-project-safe.firebaseapp.com",
  projectId: "bank-project-safe",
  storageBucket: "bank-project-safe.firebasestorage.app",
  messagingSenderId: "981484139685",
  appId: "1:981484139685:web:2246247944fa4c2a64494c"
};

    // ===============================================
    // --- GLOBAL VARIABLES ---
    let auth, db, currentUserId, unsubscribeFromTransactions;
    let isSignupMode = false;
    let tempTransferData = {};
    let currentCurrency = '₦';
    // --- DOM ELEMENT GRABBER ---
    const $ = (id) => document.getElementById(id);
    // --- All DOM Elements ---
    const authContainer = $('auth-container'),
      appContainer = $('app-container'),
      dashboardPage = $('dashboard-page'),
      transferPage = $('transfer-page');
    const fullnameField = $('fullname-field'),
      pinField = $('pin-field'),
      fullnameInput = $('fullname'),
      pinInput = $('pin');
    const emailInput = $('email'),
      passwordInput = $('password'),
      authButton = $('auth-button'),
      authErrorEl = $('auth-error'),
      authToggleLink = $('auth-toggle-link');
    const userNameEl = $('user-name'),
      balanceEl = $('balance'),
      totalIncomeEl = $('total-income'),
      totalExpenseEl = $('total-expense');
    const accountNumberEl = $('account-number'),
      routingNumberEl = $('routing-number');
    const transferBtn = $('transfer-btn'),
      billsBtn = $('bills-btn'),
      depositBtn = $('deposit-btn'),
      backToDashboardBtn = $('back-to-dashboard-btn');
    const transferForm = $('transfer-form'),
      transactionForm = $('transaction-form');
    const pinModal = $('pin-modal'),
      pinInputs = document.querySelectorAll('.pin-input'),
      pinErrorEl = $('pin-error'),
      pinConfirmBtn = $('pin-confirm-btn'),
      pinCancelBtn = $('pin-cancel-btn');
    const alertModal = $('alert-modal'),
      alertMessage = $('alert-message'),
      alertOkBtn = $('alert-ok-btn');
    const transactionListEl = $('transaction-list'),
      noTransactionsEl = $('no-transactions');
    const logoutBtn = $('logout-btn');
    const currencySelector = $('currency-selector');
    // --- HELPER & UI FUNCTIONS ---
    const showPage = (pageId) => {
      appContainer.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      $(pageId).classList.add('active');
    };
    const showAlert = (message) => {
      alertMessage.textContent = message;
      alertModal.classList.remove('hidden');
    };
    const toggleAuthMode = () => {
      isSignupMode = !isSignupMode;
      authErrorEl.textContent = '';
      $('auth-title').textContent = isSignupMode ? 'Create Your Account' : 'Welcome Back!';
      $('auth-subtitle').textContent = isSignupMode ? 'Get started.' : 'Login to continue.';
      authButton.textContent = isSignupMode ? 'Sign Up' : 'Login';
      $('auth-toggle-text').textContent = isSignupMode ? 'Already have an account?' : "Don't have an account?";
      authToggleLink.textContent = isSignupMode ? 'Login' : 'Sign Up';
      fullnameField.classList.toggle('hidden', !isSignupMode);
      pinField.classList.toggle('hidden', !isSignupMode);
    };
    const updateDashboardUI = (transactions, userData) => {
      currentCurrency = userData.currency || '₦';
      currencySelector.value = currentCurrency;
      userNameEl.textContent = userData.name || 'User';
      accountNumberEl.textContent = userData.accountNumber || 'N/A';
      routingNumberEl.textContent = userData.routingNumber || 'N/A';
      transactionListEl.innerHTML = '';
      noTransactionsEl.style.display = transactions.length === 0 ? 'block' : 'none';
      transactions.forEach(t => {
        const isIncome = t.type === 'income';
        const item = document.createElement('li');
        item.className = `bg-slate-50 p-3 rounded-lg flex justify-between items-center border-r-4 ${isIncome ? 'border-green-500' : 'border-red-500'}`;
        item.innerHTML = `<div><p class="font-medium">${t.text}</p><p class="text-xs text-slate-400">${t.createdAt?.toDate().toLocaleString() || ''}</p></div><span class="font-semibold ${isIncome ? 'text-green-600' : 'text-red-600'}">${isIncome ? '+' : '-'} ${currentCurrency}${Math.abs(t.amount).toFixed(2)}</span>`;
        transactionListEl.appendChild(item);
      });
      const amounts = transactions.map(t => t.amount);
      const income = amounts.filter(item => item > 0).reduce((acc, item) => acc + item, 0);
      const expense = amounts.filter(item => item < 0).reduce((acc, item) => acc + item, 0);
      balanceEl.innerText = `${currentCurrency}${(income + expense).toFixed(2)}`;
      totalIncomeEl.innerText = `${currentCurrency}${income.toFixed(2)}`;
      totalExpenseEl.innerText = `${currentCurrency}${Math.abs(expense).toFixed(2)}`;
    };
    pinInputs.forEach((input, index) => {
      input.addEventListener('keyup', (e) => {
        if (e.key >= 0 && e.key <= 9) {
          pinInputs[index].value = e.key;
          if (index < 3) pinInputs[index + 1].focus();
        } else if (e.key === 'Backspace') {
          pinInputs[index].value = '';
          if (index > 0) pinInputs[index - 1].focus();
        }
      });
    });
    const showPinModal = () => {
      pinErrorEl.textContent = '';
      pinInputs.forEach(i => i.value = '');
      pinModal.classList.remove('hidden');
      pinInputs[0].focus();
    };
    const hidePinModal = () => pinModal.classList.add('hidden');
    // --- FIREBASE LOGIC ---
    try {
      const app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
    } catch (error) {
      console.error("Firebase Init Error:", error);
      showAlert("CRITICAL ERROR: Could not connect to the database. Check your firebaseConfig keys.");
    }
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUserId = user.uid;
        authContainer.classList.remove('active');
        appContainer.classList.add('active');
        listenForData();
      } else {
        currentUserId = null;
        authContainer.classList.add('active');
        appContainer.classList.remove('active');
        if (unsubscribeFromTransactions) unsubscribeFromTransactions();
      }
    });
    const handleAuthAction = async () => {
      const email = emailInput.value,
        password = passwordInput.value;
      authErrorEl.textContent = '';
      try {
        if (isSignupMode) {
          const fullname = fullnameInput.value,
            pin = pinInput.value;
          if (fullname.trim() === '') return authErrorEl.textContent = 'Please enter your full name.';
          if (!/^\d{4}$/.test(pin)) return authErrorEl.textContent = 'PIN must be exactly 4 digits.';
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          const userDocRef = doc(db, 'users', userCredential.user.uid);
          await setDoc(userDocRef, {
            name: fullname,
            pin: pin,
            accountNumber: Math.floor(1000000000 + Math.random() * 9000000000).toString(),
            routingNumber: Math.floor(100000000 + Math.random() * 900000000).toString(),
            currency: '₦' // Default currency for new users
          });
        } else {
          await signInWithEmailAndPassword(auth, email, password);
        }
      } catch (error) {
        authErrorEl.textContent = error.message;
      }
    };
    const listenForData = () => {
      if (unsubscribeFromTransactions) unsubscribeFromTransactions();
      const userDocRef = doc(db, 'users', currentUserId);
      unsubscribeFromTransactions = onSnapshot(query(collection(db, 'users', currentUserId, 'transactions'), orderBy('createdAt', 'desc')), async (snapshot) => {
        const userDoc = await getDoc(userDocRef);
        const userData = userDoc.data() || {};
        const transactions = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        updateDashboardUI(transactions, userData);
      });
    };
    const handleAddTransaction = async (e) => {
      e.preventDefault();
      const description = $('description').value;
      const amount = +$('amount').value;
      const type = $('type').value;
      if (description.trim() === '' || !amount) return;
      const newTransaction = {
        text: description,
        amount: type === 'income' ? amount : -amount,
        type: type,
        createdAt: serverTimestamp()
      };
      try {
        await addDoc(collection(db, 'users', currentUserId, 'transactions'), newTransaction);
        transactionForm.reset();
      } catch (error) {
        console.error("Error adding transaction: ", error);
        showAlert("Could not add transaction. Please try again.");
      }
    };
    const handleTransferSubmit = (e) => {
      e.preventDefault();
      const amount = +$('transfer-amount').value;
      if (!amount) return;
      tempTransferData = {
        text: `Transfer to ${$('recipient-name').value}`,
        amount: -amount,
        type: 'expense',
        createdAt: serverTimestamp()
      };
      showPinModal();
    };
    const confirmTransferWithPin = async () => {
      let enteredPin = "";
      pinInputs.forEach(i => enteredPin += i.value);
      const userDoc = await getDoc(doc(db, 'users', currentUserId));
      if (enteredPin === userDoc.data().pin) {
        await addDoc(collection(db, 'users', currentUserId, 'transactions'), tempTransferData);
        hidePinModal();
        showAlert("Transfer successful!");
        transferForm.reset();
        showPage('dashboard-page');
      } else {
        pinErrorEl.textContent = 'Incorrect PIN.';
      }
    };
    const handleCurrencyChange = async () => {
      const newCurrency = currencySelector.value;
      const userDocRef = doc(db, 'users', currentUserId);
      await updateDoc(userDocRef, {
        currency: newCurrency
      });
    };
    // --- PWA Service Worker ---
    if ('serviceWorker' in navigator) {
      const swContent = `
                const CACHE_NAME = 'my-bank-app-v1';
                self.addEventListener('install', e => { e.waitUntil(caches.open(CACHE_NAME).then(c => c.add('/'))) });
                self.addEventListener('fetch', e => { e.respondWith(caches.match(e.request).then(res => res || fetch(e.request))) });
            `;
      const blob = new Blob([swContent], {
        type: 'application/javascript'
      });
      const swUrl = URL.createObjectURL(blob);
      navigator.serviceWorker.register(swUrl)
        .then(reg => console.log('Service worker registered.', reg))
        .catch(err => console.log('Service worker not registered.', err));
    }
    // --- EVENT LISTENERS ---
    authButton.addEventListener('click', handleAuthAction);
    authToggleLink.addEventListener('click', (e) => {
      e.preventDefault();
      toggleAuthMode();
    });
    logoutBtn.addEventListener('click', () => signOut(auth));
    transferBtn.addEventListener('click', () => showPage('transfer-page'));
    backToDashboardBtn.addEventListener('click', () => showPage('dashboard-page'));
    billsBtn.addEventListener('click', () => showAlert('This feature is coming soon!'));
    depositBtn.addEventListener('click', () => showAlert('This feature is coming soon!'));
    transactionForm.addEventListener('submit', handleAddTransaction);
    transferForm.addEventListener('submit', handleTransferSubmit);
    pinConfirmBtn.addEventListener('click', confirmTransferWithPin);
    pinCancelBtn.addEventListener('click', hidePinModal);
    alertOkBtn.addEventListener('click', () => alertModal.classList.add('hidden'));
    currencySelector.addEventListener('change', handleCurrencyChange);
  </script>
</body>

</html>
